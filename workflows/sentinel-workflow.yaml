# Sentinel Liquidity Manager - Chainlink CRE Workflow
# This workflow orchestrates automated liquidity rebalancing for Uniswap v4

name: sentinel-liquidity-manager
description: Trust-minimized agentic liquidity management with yield optimization
version: 1.0.0

# Network Configuration
network:
  chain: base-mainnet
  chainId: 8453

# Contract Addresses (Base Mainnet) ## need to to testnet
contracts:
  sentinelHook: "0x0000000000000000000000000000000000000000" # TODO: Update after deployment
  poolManager: "0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865"
  aavePool: "0xA238Dd80C259a72e81d7e4664a9801593F98d1c5"

# Data Sources
dataSources:
  chainlink:
    - name: eth-usd
      address: "0x71041dddad3595F9CEd3DcCFBe3D1F4b0a16Bb70"
      description: "ETH/USD price feed on Base"
    - name: usdc-usd
      address: "0x7e860098F58bBFC8648a4311b374B1D669a2bc6B"
      description: "USDC/USD price feed on Base"

# Workflow Definition
workflow:
  # ===================================================================
  # TRIGGER: Monitor for TickCrossed events
  # ===================================================================
  trigger:
    type: event
    contract: "${contracts.sentinelHook}"
    event: TickCrossed
    abi:
      - "event TickCrossed(int24 indexed tickLower, int24 indexed tickUpper, int24 indexed currentTick)"
    description: "Triggered when price crosses outside the active range"
    
    # Also run on a time-based schedule as backup
    fallback:
      type: cron
      schedule: "0 */6 * * *" # Every 6 hours
      description: "Periodic check for rebalancing opportunities"

  # ===================================================================
  # STEP 1: Fetch Market Data
  # ===================================================================
  steps:
    - name: fetch_market_data
      type: http_request
      method: GET
      url: "https://api.coingecko.com/api/v3/simple/price"
      params:
        ids: "ethereum,usd-coin"
        vs_currencies: "usd"
        include_24hr_vol: "true"
        include_24hr_change: "true"
      output: marketData
      description: "Fetch current market prices and 24h volatility"

    - name: get_chainlink_price
      type: read_contract
      contract: "${dataSources.chainlink[0].address}"
      function: "latestRoundData"
      output: oracleData
      description: "Get authoritative price from Chainlink"

    - name: get_pool_state
      type: read_contract
      contract: "${contracts.poolManager}"
      function: "getSlot0"
      args:
        poolKey: "${workflow.trigger.poolKey}"
      output: poolState
      description: "Get current pool state (price, tick, etc.)"

  # ===================================================================
  # STEP 2: Calculate Volatility & Strategy
  # ===================================================================
    - name: calculate_volatility
      type: compute
      language: javascript
      code: |
        // Calculate 24h volatility in basis points
        const priceChange24h = Math.abs(marketData.ethereum.usd_24h_change || 0);
        const volatility = Math.floor(priceChange24h * 100); // Convert to basis points
        
        // Volatility buckets for strategy
        let strategy = {};
        if (volatility < 200) {
          // Low volatility (< 2%): Tight range, more idle capital
          strategy = {
            rangeWidth: 200,
            volatilityBps: volatility,
            riskLevel: "low"
          };
        } else if (volatility < 500) {
          // Medium volatility (2-5%): Medium range
          strategy = {
            rangeWidth: 600,
            volatilityBps: volatility,
            riskLevel: "medium"
          };
        } else {
          // High volatility (> 5%): Wide range, more active capital
          strategy = {
            rangeWidth: 1500,
            volatilityBps: volatility,
            riskLevel: "high"
          };
        }
        
        return strategy;
      output: volatilityStrategy
      description: "Calculate optimal range based on market volatility"

    - name: calculate_new_range
      type: compute
      language: javascript
      code: |
        // Get current tick from pool state
        const currentTick = poolState.tick;
        const rangeWidth = volatilityStrategy.rangeWidth;
        
        // Calculate symmetric range around current price
        const tickSpacing = 60; // Common tick spacing for 0.3% fee tier
        const halfRange = Math.floor(rangeWidth / 2);
        
        // Round to tick spacing
        const newTickLower = Math.floor((currentTick - halfRange) / tickSpacing) * tickSpacing;
        const newTickUpper = Math.ceil((currentTick + halfRange) / tickSpacing) * tickSpacing;
        
        return {
          tickLower: newTickLower,
          tickUpper: newTickUpper,
          currentTick: currentTick,
          rangeWidth: newTickUpper - newTickLower,
          volatility: volatilityStrategy.volatilityBps
        };
      output: newRange
      description: "Calculate new optimal liquidity range"

  # ===================================================================
  # STEP 3: DON Consensus
  # ===================================================================
    - name: report_consensus
      type: consensus
      input:
        newTickLower: "${newRange.tickLower}"
        newTickUpper: "${newRange.tickUpper}"
        volatility: "${newRange.volatility}"
      threshold: 0.66 # 66% of DON nodes must agree
      description: "Decentralized consensus on rebalancing parameters"
      
      # Validation rules
      validation:
        - check: "newRange.tickLower < newRange.currentTick"
          error: "Lower tick must be below current tick"
        - check: "newRange.tickUpper > newRange.currentTick"
          error: "Upper tick must be above current tick"
        - check: "newRange.rangeWidth >= 100"
          error: "Range too narrow (min 100 ticks)"
        - check: "newRange.rangeWidth <= 5000"
          error: "Range too wide (max 5000 ticks)"

  # ===================================================================
  # STEP 4: Execute Rebalancing Transaction
  # ===================================================================
    - name: execute_rebalance
      type: write_contract
      contract: "${contracts.sentinelHook}"
      function: "maintain"
      args:
        - newTickLower: "${newRange.tickLower}"
        - newTickUpper: "${newRange.tickUpper}"
        - volatility: "${newRange.volatility}"
      gas_limit: 500000
      condition: "${report_consensus.approved == true}"
      description: "Submit rebalancing transaction to SentinelHook"

  # ===================================================================
  # STEP 5: Post-Execution Monitoring
  # ===================================================================
    - name: monitor_execution
      type: event_listener
      events:
        - contract: "${contracts.sentinelHook}"
          event: "LiquidityRebalanced"
          timeout: 300 # 5 minutes
      description: "Wait for rebalancing confirmation"

    - name: log_metrics
      type: webhook
      url: "${env.METRICS_WEBHOOK_URL}"
      method: POST
      body:
        timestamp: "${block.timestamp}"
        txHash: "${execute_rebalance.txHash}"
        newRange:
          tickLower: "${newRange.tickLower}"
          tickUpper: "${newRange.tickUpper}"
        volatility: "${newRange.volatility}"
        gasUsed: "${execute_rebalance.gasUsed}"
      description: "Log execution metrics for analytics"

# Security & Error Handling
security:
  max_gas_price: 50000000000 # 50 gwei max
  retry_policy:
    max_attempts: 3
    backoff: exponential
  circuit_breaker:
    enabled: true
    conditions:
      - type: price_deviation
        threshold: 10 # 10% deviation triggers circuit breaker
      - type: gas_spike
        threshold: 200 # 200% above average

# Monitoring & Alerts
monitoring:
  alerts:
    - name: rebalance_success
      condition: "${execute_rebalance.success == true}"
      channel: slack
      message: "âœ… Sentinel: Liquidity rebalanced successfully"
    
    - name: rebalance_failure
      condition: "${execute_rebalance.success == false}"
      channel: pagerduty
      severity: high
      message: "ðŸš¨ Sentinel: Rebalancing failed - manual intervention required"
    
    - name: high_volatility
      condition: "${volatilityStrategy.riskLevel == 'high'}"
      channel: slack
      message: "âš ï¸ Sentinel: High market volatility detected (${volatilityStrategy.volatilityBps} bps)"

# Documentation References
documentation:
  - title: "Sentinel Architecture"
    url: "https://github.com/sentinel-protocol/docs/architecture.md"
  - title: "Uniswap v4 Hooks"
    url: "https://docs.uniswap.org/contracts/v4/concepts/hooks"
  - title: "Chainlink CRE"
    url: "https://docs.chain.link/chainlink-automation"
